import express from "express";
import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const USERS_PATH = path.join(__dirname, "../users.json"); // server/users.json

function loadUsers() {
  try {
    return JSON.parse(fs.readFileSync(USERS_PATH, "utf8"));
  } catch (e) {
    return [];
  }
}
function saveUsers(users) {
  fs.writeFileSync(USERS_PATH, JSON.stringify(users, null, 2));
}

const router = express.Router();

router.post("/", (req, res) => {
  const { open_id, nickname, avatar } = req.body;
  if (!open_id) return res.status(400).json({ error: "Missing open_id" });

  const users = loadUsers();
  let user = users.find(u => u.open_id === open_id);

  if (!user) {
    user = {
      open_id,
      nickname,
      avatar,
      wins: 0,
      losses: 0,
      level: 1,
      deck: [],
      created_at: Date.now()
    };
    users.push(user);
  } else {
    user.nickname = nickname;
    user.avatar = avatar;
  }

  saveUsers(users);
  return res.json(user);
});

export default router;
